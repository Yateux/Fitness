import React from 'react';
import styled from 'styled-components';

// --- Interfaces ---

interface UsageChartProps {
  size?: number;
  strokeWidth?: number;
  value?: number;    // La valeur actuelle (ex: 20)
  max?: number;      // La valeur maximum (ex: 300)
}

interface StyledProps {
  $size?: number;
  $strokeWidth?: number;
  $color?: string;
  $dashArray?: string;
  $dashOffset?: number;
}

// --- Composants Stylisés ---

const Wrapper = styled.div<StyledProps>`
  display: inline-flex;
  align-items: center;
  gap: ${props => (props.$size ? props.$size / 4 : 8)}px;
  font-family: sans-serif;
`;

const ChartSvg = styled.svg`
  transform: rotate(-90deg);
  display: block;
  flex-shrink: 0;
`;

const ChartCircle = styled.circle<StyledProps>`
  fill: none;
  stroke-width: ${props => props.$strokeWidth}px;
  stroke-linecap: round;
  transition: all 0.4s ease-out;
  stroke: ${props => props.$color};
  stroke-dasharray: ${props => props.$dashArray};
  stroke-dashoffset: ${props => props.$dashOffset};
`;

// --- Composant Principal ---

const DynamicUsageChart: React.FC<UsageChartProps> = ({ 
  size = 30, 
  strokeWidth = 4, 
  value = 20,
  max = 100 
}) => {
  // Calcul du ratio réel par rapport au max
  const ratio = value / max;
  
  // Géométrie
  const radius = (size - strokeWidth) / 2;
  const circumference = 2 * Math.PI * radius;
  
  // Le gap s'adapte à la circonférence
  const autoGap = circumference * 0.05;
  
  // Calcul des segments
  // Orange = la valeur actuelle
  const orangeDash = (ratio * circumference) - autoGap;
  // Bleu = le reste jusqu'au max
  const blueDash = ((1 - ratio) * circumference) - autoGap;

  // Sécurité pour éviter les valeurs négatives si le gap est trop grand
  const finalOrange = Math.max(0, orangeDash);
  const finalBlue = Math.max(0, blueDash);

  return (
    <Wrapper $size={size}>
      <ChartSvg width={size} height={size} viewBox={`0 0 ${size} ${size}`}>
        
        {/* Segment Bleu (Le reste) */}
        <ChartCircle
          cx={size / 2}
          cy={size / 2}
          r={radius}
          $strokeWidth={strokeWidth}
          $color="#6d8bc4"
          $dashArray={`${finalBlue} ${circumference - finalBlue}`}
          // On le décale pour qu'il commence après le segment orange
          $dashOffset={-(ratio * circumference + autoGap / 2)}
        />

        {/* Segment Orange (La progression / Valeur) */}
        <ChartCircle
          cx={size / 2}
          cy={size / 2}
          r={radius}
          $strokeWidth={strokeWidth}
          $color="#f08036"
          $dashArray={`${finalOrange} ${circumference - finalOrange}`}
          $dashOffset={-autoGap / 2}
        />
      </svg>
    </Wrapper>
  );
};

export default DynamicUsageChart;
